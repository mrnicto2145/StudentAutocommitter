name: PEP8 Code Style Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  pep8-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install PEP8 tools
      run: |
        python -m pip install --upgrade pip
        pip install pycodestyle==2.11.1 flake8==7.0.0
    
    - name: Python version
      run: python --version
    
    - name: Run pycodestyle (PEP8)
      run: |
        echo "=== pycodestyle PEP8 Check ==="
        if pycodestyle --max-line-length=120 src/; then
          echo "✅ No PEP8 violations found"
        else
          echo "❌ PEP8 violations found"
        fi
    
    - name: Run flake8 (syntax and style)
      run: |
        echo "=== flake8 Syntax and Style Check ==="
        echo "Checking for critical errors..."
        if flake8 src/ --select=E9,F63,F7,F82 --show-source; then
          echo "✅ No critical errors found"
        else
          echo "❌ Critical errors found"
        fi
        
        echo ""
        echo "Checking complexity and style..."
        flake8 src/ --max-complexity=20 --max-line-length=120 --statistics
    
    - name: Generate PEP8 report
      run: |
        echo "# PEP8 Code Style Report" > pep8-report.md
        echo "Generated: $(date -u)" >> pep8-report.md
        echo "Branch: ${{ github.ref }}" >> pep8-report.md
        echo "Commit: ${{ github.sha }}" >> pep8-report.md
        echo "" >> pep8-report.md
        
        echo "## Pycodestyle Results" >> pep8-report.md
        echo '```' >> pep8-report.md
        pycodestyle --max-line-length=120 --statistics src/ 2>&1 | tee -a pep8-report.md
        echo '```' >> pep8-report.md
        echo "" >> pep8-report.md
        
        echo "## Flake8 Results" >> pep8-report.md
        echo '```' >> pep8-report.md
        flake8 src/ --max-complexity=20 --max-line-length=120 --statistics 2>&1 | tee -a pep8-report.md
        echo '```' >> pep8-report.md
        
        echo "## File-by-file analysis" >> pep8-report.md
        echo '```' >> pep8-report.md
        for file in src/*.py; do
          if [ -f "$file" ]; then
            echo "=== $file ==="
            pycodestyle --max-line-length=120 "$file" 2>/dev/null || true
            echo ""
          fi
        done
        echo '```' >> pep8-report.md
    
    - name: Upload PEP8 Report
      uses: actions/upload-artifact@v4
      with:
        name: pep8-code-report
        path: pep8-report.md
        retention-days: 30