name: PEP8 Code Style Check

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  pep8-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install pycodestyle and flake8
      run: |
        python -m pip install --upgrade pip
        pip install pycodestyle flake8
    
    - name: Check Python version
      run: python --version
    
    - name: PEP8 Check with pycodestyle
      run: |
        echo "=== Running pycodestyle (PEP8) check ==="
        pycodestyle --max-line-length=79 --statistics src/ || true
        echo ""
        echo "=== Detailed PEP8 violations ==="
        pycodestyle --max-line-length=79 src/ || echo "No PEP8 violations found"
    
    - name: Flake8 Check
      run: |
        echo "=== Running flake8 check ==="
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo ""
        echo "=== Flake8 complexity and style ==="
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=79 --statistics
    
    - name: Check for syntax errors
      run: |
        echo "=== Checking for Python syntax errors ==="
        python -m py_compile src/*.py || true
        for file in src/*.py; do
          if python -m py_compile "$file" 2>/dev/null; then
            echo "✓ $file - Syntax OK"
          else
            echo "✗ $file - Syntax error"
            python -m py_compile "$file"
          fi
        done
    
    - name: Create PEP8 Report
      if: always()
      run: |
        echo "# PEP8 Code Style Report" > pep8-report.md
        echo "Generated: $(date)" >> pep8-report.md
        echo "" >> pep8-report.md
        echo "## Summary" >> pep8-report.md
        echo "" >> pep8-report.md
        
        # Run pycodestyle and capture output
        pycodestyle --max-line-length=79 --statistics src/ > pep8_stats.txt 2>&1 || true
        echo "### Pycodestyle Statistics" >> pep8-report.md
        echo '```' >> pep8-report.md
        cat pep8_stats.txt >> pep8-report.md
        echo '```' >> pep8-report.md
        echo "" >> pep8-report.md
        
        # Run flake8 and capture output
        echo "### Flake8 Check" >> pep8-report.md
        echo '```' >> pep8-report.md
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=79 >> pep8-report.md 2>&1
        echo '```' >> pep8-report.md
    
    - name: Upload PEP8 Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: pep8-report
        path: |
          pep8-report.md
          pep8_stats.txt
        retention-days: 7